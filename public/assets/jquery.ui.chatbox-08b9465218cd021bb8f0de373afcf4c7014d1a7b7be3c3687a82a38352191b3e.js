/*
 * Copyright 2010, Wen Pu (dexterpu at gmail dot com)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Check out http://www.cs.illinois.edu/homes/wenpu1/chatbox.html for document
 *
 * Depends on jquery.ui.core, jquery.ui.widiget, jquery.ui.effect
 *
 * Also uses some styles for jquery.ui.dialog
 *
 */
!function(t){t.widget("ui.chatbox",{options:{id:null,title:null,user:null,hidden:!1,offset:0,width:300,messageSent:function(t,i,o){this.boxManager.addMsg(i.first_name,o)},boxClosed:function(t){},boxManager:{init:function(t){this.elem=t},addMsg:function(i,o){var e=this,a=e.elem.uiChatboxLog,n=document.createElement("div");a.append(n),t(n).hide();var s=!1;if(i){var h=document.createElement("b");t(h).text(i+": "),n.appendChild(h)}else s=!0;var u=document.createElement(s?"i":"span");t(u).text(o),n.appendChild(u),t(n).addClass("ui-chatbox-msg"),t(n).css("maxWidth",t(a).width()),t(n).fadeIn(),e._scrollToBottom(),e.elem.uiChatboxTitlebar.hasClass("ui-state-focus")||e.highlightLock||(e.highlightLock=!0,e.highlightBox())},highlightBox:function(){var t=this;t.elem.uiChatboxTitlebar.effect("highlight",{color:"#0085c7"},300),t.elem.uiChatbox.effect("bounce",{times:3},300,function(){t.highlightLock=!1,t._scrollToBottom()})},toggleBox:function(){this.elem.uiChatbox.toggle()},_scrollToBottom:function(){var t=this.elem.uiChatboxLog;t.scrollTop(t.get(0).scrollHeight)}}},toggleContent:function(i){if(this.uiChatboxContent.toggle(),this.uiChatboxContent.is(":visible")){t("#ui-chatbox").css("height","385px");var o=t("#gl-sidebar").height()-t("#ui-chatbox").height();t("#ui-chatbox").css("top",o),t("#chatbox-notification-icon").css("display","none"),this.uiChatboxInputBox.focus()}else{t("#ui-chatbox").css("height",t("#chatbox-title-bar").height());var o=t("#gl-sidebar").height()-3*t("#chatbox-title-bar").height();t("#ui-chatbox").css("top",o)}},widget:function(){return this.uiChatbox},_create:function(){var i=this,o=i.options,e=o.title||"No Title",a=(i.uiChatbox=t('<div id="ui-chatbox" style="position: absolute;bottom: -200px;"></div>')).appendTo(t("#gl-sidebar")).addClass("ui-widget ui-corner-top").attr("outline",0).focusin(function(){i.uiChatboxTitlebar.addClass("ui-state-focus")}).focusout(function(){i.uiChatboxTitlebar.removeClass("ui-state-focus")}),n=(i.uiChatboxTitlebar=t('<div id="chatbox-title-bar"></div>')).addClass("ui-widget-header ui-corner-top ui-chatbox-titlebar ui-dialog-header").click(function(t){i.toggleContent(t)}).appendTo(a),s=((i.uiChatboxTitle=t("<span></span>")).html(e).appendTo(n),(i.uiChatboxTitlebarNotification=t('<div id="chatbox-notification-icon" style="display: none;"><img src="/assets/icon_notification.png" /></div>')).appendTo(n),(i.uiChatboxTitlebarMinimize=t('<a href="#"></a>')).addClass("ui-corner-all ui-chatbox-icon").attr("role","button").hover(function(){s.addClass("ui-state-hover")},function(){s.removeClass("ui-state-hover")}).click(function(t){return i.toggleContent(t),!1}).appendTo(n)),h=(t("<span></span>").addClass("ui-icon ui-icon-minusthick").text("minimize").appendTo(s),(i.uiChatboxContent=t("<div></div>")).addClass("ui-widget-content ui-chatbox-content ").appendTo(a)),u=((i.uiChatboxLog=i.element).addClass("ui-widget-content ui-chatbox-log").appendTo(h),(i.uiChatboxInput=t("<div></div>")).addClass("ui-chatbox-input").click(function(t){}).appendTo(h)),c=(i.uiChatboxInputBox=t("<textarea></textarea>")).addClass("ui-chatbox-input-box").appendTo(u).keydown(function(o){return o.keyCode&&o.keyCode==t.ui.keyCode.ENTER?(msg=t.trim(t(this).val()),msg.length>0&&i.options.messageSent(i.options.id,i.options.user,msg),t(this).val(""),!1):void 0}).focusin(function(){c.addClass("ui-chatbox-input-focus");var i=t(this).parent().prev();i.scrollTop(i.get(0).scrollHeight)}).focusout(function(){c.removeClass("ui-chatbox-input-focus")});n.find("*").add(n).disableSelection(),h.children().click(function(){i.uiChatboxInputBox.focus()}),i._setWidth(i.options.width),i._position(i.options.offset),i.options.boxManager.init(i),i.options.hidden||a.show()},_setOption:function(i,o){if(null!=o)switch(i){case"hidden":o?this.uiChatbox.hide():this.uiChatbox.show();break;case"offset":this._position(o);break;case"width":this._setWidth(o)}t.Widget.prototype._setOption.apply(this,arguments)},_setWidth:function(t){t=100,this.uiChatboxTitlebar.width(t-8+"%"),this.uiChatboxLog.width(t-8+"%"),this.uiChatboxInput.css("maxWidth",t-0+"%"),this.uiChatboxInputBox.css("width",t-4+"%")},_position:function(t){this.uiChatbox.css("right",t)}})}(jQuery);